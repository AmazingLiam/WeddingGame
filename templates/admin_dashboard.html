{% extends "base.html" %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<div class="admin-dashboard" style="padding: 15px; min-height: 100vh;">
    <div style="max-width: 600px; margin: 0 auto;">
        <!-- Header -->
        <div class="mb-3">
            <h2 style="font-size: 1.5rem; margin-bottom: 10px;">Admin Dashboard</h2>
            <div class="d-flex flex-wrap gap-2">
                <a href="{{ url_for('admin_leaderboard') }}" class="btn btn-info btn-sm">Leaderboard</a>
                <button class="btn btn-secondary btn-sm" onclick="location.reload()">Refresh</button>
                <a href="{{ url_for('admin_logout') }}" class="btn btn-danger btn-sm">Logout</a>
            </div>
        </div>

        <!-- Submission Count -->
        <div class="card mb-3">
            <div class="card-body p-3">
                <h5 class="card-title" style="font-size: 1rem;">Submissions</h5>
                <p class="display-6" style="font-size: 1.8rem;">{{ submission_count.submitted }} / {{ submission_count.total }}</p>
                <div class="progress" style="height: 20px;">
                    {% set percentage = (submission_count.submitted / submission_count.total * 100) | int %}
                    <div class="progress-bar" role="progressbar" style="width: {{ percentage }}%" aria-valuenow="{{ percentage }}" aria-valuemin="0" aria-valuemax="100">
                        {{ percentage }}%
                    </div>
                </div>
            </div>
        </div>

        <!-- Update Actual Answers -->
        <div class="card">
            <div class="card-header p-2">
                <h5 class="mb-0" style="font-size: 1rem;">Update Actual Answers</h5>
            </div>
            <div class="card-body p-2">
                <p class="text-muted mb-3" style="font-size: 0.85rem;">Enter the actual answers as events happen.</p>

                {% for question in questions %}
                <div class="mb-3 p-2 admin-question-container" style="border-radius: 8px;">
                    <div class="d-flex align-items-center gap-2 mb-1">
                        <span class="status-indicator" id="status-{{ question.id }}" style="font-size: 1.2rem;">
                            {% if question.actual_answer is not none and question.actual_answer != '' %}
                                <span style="color: #28a745;">&#10004;</span>
                            {% else %}
                                <span style="color: #dc3545;">&#10008;</span>
                            {% endif %}
                        </span>
                        <label class="form-label mb-0" style="font-size: 0.9rem;">
                            <strong>Q{{ question.order_index }}:</strong> {{ question.question_text }}
                        </label>
                    </div>
                    {% if question.question_type == 'time' %}
                    <div class="d-flex gap-2 align-items-center">
                        <input type="time" class="form-control answer-input" id="answer-{{ question.id }}"
                               value="{{ question.actual_answer | format_time if question.actual_answer else '' }}"
                               style="font-size: 16px; padding: 10px; flex: 1;"
                               data-question-id="{{ question.id }}"
                               data-question-type="time">
                        <button class="btn {% if question.actual_answer is not none and question.actual_answer != '' %}btn-success{% else %}btn-primary{% endif %} btn-sm save-btn" id="save-btn-{{ question.id }}" type="button" onclick="updateAnswer({{ question.id }})" style="padding: 10px 15px;">
                            {% if question.actual_answer is not none and question.actual_answer != '' %}&#10004; Saved{% else %}Save{% endif %}
                        </button>
                    </div>
                    {% else %}
                    <div class="d-flex gap-2 align-items-center">
                        <input type="number" class="form-control answer-input" id="answer-{{ question.id }}"
                               placeholder="Enter value"
                               value="{{ question.actual_answer | int if question.actual_answer else '' }}"
                               style="font-size: 16px; padding: 10px; flex: 1;"
                               data-question-id="{{ question.id }}"
                               data-question-type="number">
                        <span class="text-muted" style="font-size: 0.85rem; min-width: 50px;">{{ question.unit }}</span>
                        <button class="btn {% if question.actual_answer is not none and question.actual_answer != '' %}btn-success{% else %}btn-primary{% endif %} btn-sm save-btn" id="save-btn-{{ question.id }}" type="button" onclick="updateAnswer({{ question.id }})" style="padding: 10px 15px;">
                            {% if question.actual_answer is not none and question.actual_answer != '' %}&#10004; Saved{% else %}Save{% endif %}
                        </button>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
async function updateAnswer(questionId) {
    const input = document.getElementById(`answer-${questionId}`);
    let actualAnswer = input.value.trim();
    const questionType = input.dataset.questionType;

    if (!actualAnswer) {
        alert('Please enter an answer');
        return;
    }

    // Convert time to minutes for storage
    if (questionType === 'time' && actualAnswer.includes(':')) {
        const [hours, minutes] = actualAnswer.split(':').map(Number);
        actualAnswer = hours * 60 + minutes;
    }

    try {
        const response = await fetch('/admin/update-answer', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                question_id: questionId,
                actual_answer: actualAnswer
            })
        });

        if (response.ok) {
            // Update button to green tick permanently
            const button = document.getElementById(`save-btn-${questionId}`);
            button.innerHTML = '&#10004; Saved';
            button.classList.remove('btn-primary');
            button.classList.add('btn-success');

            // Update status indicator to green tick
            const status = document.getElementById(`status-${questionId}`);
            status.innerHTML = '<span style="color: #28a745;">&#10004;</span>';
        } else {
            alert('Error saving answer');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error saving answer');
    }
}
</script>
{% endblock %}
