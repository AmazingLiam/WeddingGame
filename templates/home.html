{% extends "base.html" %}

{% block title %}The Hancox Wedding Sweepstake{% endblock %}

{% block navbar %}{% endblock %}
{% block footer %}{% endblock %}

{% block content %}
<div class="home-container page-content">
    <div class="home-overlay">
        <div class="home-content">
            <h1 class="home-title mb-4">The Hancox Wedding Sweepstake</h1>
            <p class="home-subtitle mb-5">Make your predictions and see how accurate you are!</p>

            <button type="button" class="btn btn-lg start-button mb-4" onclick="startGame()">
                Start
            </button>

            <button type="button" class="qr-codes-inline" onclick="openQRModal()">
                Guest QR Codes
            </button>
        </div>
    </div>

    <a href="{{ url_for('admin_login') }}" class="admin-link" title="Admin">&#9881;</a>
</div>

<div class="qr-modal-overlay" id="qrModal" onclick="handleModalClick(event)">
    <div class="qr-modal" onclick="event.stopPropagation()">
        <div id="guestListView">
            <h4>QR Codes</h4>
            <p class="text-muted mb-3">Select a guest to view their QR code</p>
            <div class="guest-list" id="guestList">
                <p class="text-center text-muted">Loading...</p>
            </div>
            <button type="button" class="btn btn-secondary mt-3" onclick="closeQRModal()">Close</button>
        </div>

        <div id="qrDisplayView" style="display: none;">
            <h4 id="qrGuestName"></h4>
            <div class="qr-image-container">
                <img id="qrImage" src="" alt="QR Code">
            </div>
            <p class="text-muted mt-2" style="font-size: 14px;">Scan to view answers</p>
            <div class="d-grid gap-2 mt-3">
                <button type="button" class="btn btn-primary" onclick="showGuestList()">Back to List</button>
                <button type="button" class="btn btn-secondary" onclick="closeQRModal()">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
let guestsData = [];

function startGame() {
    if (document.documentElement.requestFullscreen && !document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(() => {});
    }
    document.querySelector('.page-content').classList.add('fade-out');
    setTimeout(() => { window.location.href = '/search'; }, 300);
}

async function openQRModal() {
    document.getElementById('qrModal').classList.add('active');
    showGuestList();
    await loadGuests();
}

function closeQRModal() { document.getElementById('qrModal').classList.remove('active'); }

function handleModalClick(event) {
    if (event.target === document.getElementById('qrModal')) closeQRModal();
}

async function loadGuests() {
    try {
        const response = await fetch('/api/submitted-guests');
        guestsData = await response.json();
        renderGuestList();
    } catch (error) {
        console.error('Error loading guests:', error);
        document.getElementById('guestList').innerHTML = '<p class="text-center text-danger p-3">Error loading guests</p>';
    }
}

function renderGuestList() {
    const guestList = document.getElementById('guestList');
    if (guestsData.length === 0) {
        guestList.innerHTML = '<div class="no-guests">No guests have submitted answers yet.</div>';
        return;
    }
    guestList.innerHTML = guestsData.map(guest =>
        '<div class="guest-item" onclick="showQRCode(' + guest.id + ')">' +
            '<span class="name">' + guest.full_name + '</span>' +
            '<span class="arrow">&#8250;</span>' +
        '</div>'
    ).join('');
}

function showGuestList() {
    document.getElementById('guestListView').style.display = 'block';
    document.getElementById('qrDisplayView').style.display = 'none';
}

function showQRCode(guestId) {
    const guest = guestsData.find(g => g.id === guestId);
    if (!guest) return;
    document.getElementById('qrGuestName').textContent = guest.full_name;
    document.getElementById('qrImage').src = '/static/' + guest.qr_code_path;
    document.getElementById('guestListView').style.display = 'none';
    document.getElementById('qrDisplayView').style.display = 'block';
}
</script>
{% endblock %}
